<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursery Price Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .highlight-lowest {
            background-color: #dcfce7 !important; /* Green-100 */
            border: 2px solid #22c55e; /* Green-500 */
        }
        .highlight-highest {
            background-color: #fee2e2 !important; /* Red-100 */
            border: 2px solid #ef4444; /* Red-500 */
        }
        .rating-stars span {
            cursor: pointer;
            color: #d1d5db; /* Gray-300 */
            transition: color 0.2s;
        }
        .rating-stars span:hover,
        .rating-stars span.active {
            color: #f59e0b; /* Amber-500 */
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Nursery Price Analyzer</h1>
                <p class="text-gray-600 mt-1">Compare plant prices and quality across your favorite nurseries.</p>
            </div>
            <div class="flex space-x-3 mt-4 sm:mt-0">
                <button onclick="addNursery()" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                    + Add Nursery
                </button>
                <button onclick="addPlant()" class="bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-teal-700 transition-colors">
                    + Add Plant
                </button>
            </div>
        </header>

        <main class="bg-white rounded-xl shadow-lg border border-gray-200 p-6">
            <div id="loading" class="text-center py-16">
                <p class="text-gray-500">Loading data from Firestore...</p>
            </div>
            <div id="app-container" class="hidden">
                <div class="table-container">
                    <table class="min-w-full border-separate" style="border-spacing: 0 10px;">
                        <thead id="table-header">
                            <!-- Header will be dynamically generated here -->
                        </thead>
                        <tbody id="table-body">
                            <!-- Nursery rows will be dynamically generated here -->
                        </tbody>
                    </table>
                </div>
                 <div id="empty-state" class="hidden text-center py-16 px-6">
                    <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                        <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="mt-2 text-sm font-medium text-gray-900">No data yet</h3>
                    <p class="mt-1 text-sm text-gray-500">Get started by adding a nursery or a plant.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // --- FIREBASE CONFIGURATION ---
        // IMPORTANT: Replace with your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // --- IMPORT FIREBASE MODULES ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- INITIALIZE FIREBASE ---
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log("Firebase initialized successfully!");
        } catch (e) {
            console.error("Firebase initialization failed. Please add your Firebase config.", e);
            document.getElementById('loading').innerHTML = '<p class="text-red-600 font-semibold">Firebase Configuration Missing. Please add your config in the HTML file.</p>';
            return;
        }

        // --- GLOBAL STATE ---
        let plants = [];
        let nurseries = [];
        let prices = {}; // { "plantId_nurseryId": { price: 100, quality: 4 } }

        // --- DOM ELEMENTS ---
        const tableHeader = document.getElementById('table-header');
        const tableBody = document.getElementById('table-body');
        const loadingEl = document.getElementById('loading');
        const appContainer = document.getElementById('app-container');
        const emptyStateEl = document.getElementById('empty-state');

        // --- DATA LISTENERS (REAL-TIME) ---
        onSnapshot(collection(db, "plants"), (snapshot) => {
            plants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
            render();
        });

        onSnapshot(collection(db, "nurseries"), (snapshot) => {
            nurseries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => a.name.localeCompare(b.name));
            render();
        });

        onSnapshot(collection(db, "prices"), (snapshot) => {
            prices = {};
            snapshot.docs.forEach(doc => {
                prices[doc.id] = doc.data();
            });
            render();
        });

        // --- RENDER FUNCTION ---
        function render() {
            if (!db) return;
            loadingEl.style.display = 'none';
            appContainer.style.display = 'block';

            if (plants.length === 0 && nurseries.length === 0) {
                 emptyStateEl.style.display = 'block';
                 tableHeader.innerHTML = '';
                 tableBody.innerHTML = '';
                 return;
            }
            emptyStateEl.style.display = 'none';


            // 1. Render Header
            let headerHtml = '<tr><th class="py-3 px-4 text-left font-semibold text-gray-700 w-1/4 min-w-[200px]">Nursery / Plant</th>';
            plants.forEach(plant => {
                headerHtml += `<th class="py-3 px-4 text-center font-semibold text-gray-700 min-w-[150px]">${plant.name}</th>`;
            });
            headerHtml += '<th class="py-3 px-4 text-center font-semibold text-gray-700 min-w-[100px]">Actions</th></tr>';
            tableHeader.innerHTML = headerHtml;

            // 2. Render Body
            tableBody.innerHTML = nurseries.map(nursery => `
                <tr class="bg-white hover:bg-gray-50 transition-colors">
                    <td class="py-4 px-4 font-bold text-indigo-700 rounded-l-lg border-y border-l border-gray-200">${nursery.name}</td>
                    ${plants.map(plant => {
                        const priceKey = `${plant.id}_${nursery.id}`;
                        const priceData = prices[priceKey] || { price: '', quality: 0 };
                        return `
                        <td class="py-2 px-2 border-y border-gray-200 price-cell" data-plant-id="${plant.id}">
                            <div class="flex flex-col items-center">
                                <input 
                                    type="number" 
                                    class="w-24 p-2 text-center border rounded-md mb-2 price-input" 
                                    placeholder="Price"
                                    value="${priceData.price}"
                                    onchange="updatePrice('${plant.id}', '${nursery.id}', event.target.value)"
                                >
                                <div class="rating-stars" data-plant-id="${plant.id}" data-nursery-id="${nursery.id}">
                                    ${[1,2,3,4,5].map(star => `<span class="text-2xl ${star <= priceData.quality ? 'active' : ''}" onclick="updateQuality('${plant.id}', '${nursery.id}', ${star})">â˜…</span>`).join('')}
                                </div>
                            </div>
                        </td>
                    `}).join('')}
                    <td class="py-4 px-4 text-center rounded-r-lg border-y border-r border-gray-200">
                        <button onclick="deleteNursery('${nursery.id}')" class="text-red-500 hover:text-red-700 font-semibold">Delete</button>
                    </td>
                </tr>
            `).join('');

            // 3. Highlight Prices
            highlightPrices();
        }

        // --- PRICE & QUALITY ANALYSIS ---
        function highlightPrices() {
            // Clear previous highlights
            document.querySelectorAll('.price-cell').forEach(cell => {
                cell.classList.remove('highlight-lowest', 'highlight-highest');
            });

            plants.forEach(plant => {
                const plantPrices = [];
                nurseries.forEach(nursery => {
                    const priceKey = `${plant.id}_${nursery.id}`;
                    const priceValue = prices[priceKey] ? parseFloat(prices[priceKey].price) : null;
                    if (priceValue !== null && !isNaN(priceValue)) {
                        plantPrices.push({ value: priceValue, nurseryId: nursery.id });
                    }
                });

                if (plantPrices.length > 1) {
                    const minPrice = Math.min(...plantPrices.map(p => p.value));
                    const maxPrice = Math.max(...plantPrices.map(p => p.value));

                    plantPrices.forEach(p => {
                        const cell = document.querySelector(`.price-cell[data-plant-id="${plant.id}"] input[onchange*="'${p.nurseryId}'"]`).closest('.price-cell');
                        if (p.value === minPrice) {
                            cell.classList.add('highlight-lowest');
                        }
                        if (p.value === maxPrice) {
                            cell.classList.add('highlight-highest');
                        }
                    });
                }
            });
        }

        // --- DATABASE INTERACTIONS ---
        window.addNursery = async () => {
            const name = prompt("Enter the new nursery's name:");
            if (name && name.trim()) {
                await addDoc(collection(db, "nurseries"), { name: name.trim() });
            }
        };
        
        window.addPlant = async () => {
            const name = prompt("Enter the new plant's name:");
            if (name && name.trim()) {
                await addDoc(collection(db, "plants"), { name: name.trim() });
            }
        };

        window.updatePrice = async (plantId, nurseryId, price) => {
            const priceKey = `${plantId}_${nurseryId}`;
            const priceRef = doc(db, "prices", priceKey);
            await setDoc(priceRef, { price: parseFloat(price) || null }, { merge: true });
        };
        
        window.updateQuality = async (plantId, nurseryId, quality) => {
            const priceKey = `${plantId}_${nurseryId}`;
            const priceRef = doc(db, "prices", priceKey);
            const currentQuality = prices[priceKey]?.quality || 0;
            const newQuality = currentQuality === quality ? 0 : quality; // Toggle off if same star is clicked
            await setDoc(priceRef, { quality: newQuality }, { merge: true });
        };
        
        window.deleteNursery = async (nurseryId) => {
            if (!confirm("Are you sure you want to delete this nursery and all its price data?")) return;
            
            // Delete the nursery document
            await deleteDoc(doc(db, "nurseries", nurseryId));

            // Batch delete all related price entries
            const batch = writeBatch(db);
            Object.keys(prices).forEach(priceKey => {
                if (priceKey.endsWith(`_${nurseryId}`)) {
                    batch.delete(doc(db, "prices", priceKey));
                }
            });
            await batch.commit();
        };

    </script>
</body>
</html>

